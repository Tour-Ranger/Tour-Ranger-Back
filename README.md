[![develop CI check](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/develop-ci.yml/badge.svg)](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/develop-ci.yml)
[![main-CD](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd.yml/badge.svg)](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd.yml)
[![main-CD-elb](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd-elb.yml/badge.svg)](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd-elb.yml)

# ✈️ Tour-Ranger ✈️

### 🔰 너의 여행을 지켜줄게

프로젝트 기간 : 2023/8/16 ~ 2023/09/18

여행 상품 주문 서비스

1. 대량의 트래픽이 발생할 것으로 예상되는 이벤트 여행 상품(초특가 타임딜) 페이지
2. 대량의 여행 패키지 데이터(천만 건)에서 검색으로 필요한 여행패키지를 빠른 시간 내에 찾을 수 있게 한다.

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/bc807b8a-b684-415a-bc02-caf9a47e6177" height=300px>&nbsp;&nbsp;&nbsp;&nbsp;
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/97c8669b-b5ce-4bd7-af51-4c683a2ffde5" height=300px>
</p>

### [📚 파워레인조 Team Notion 보러가기](https://power-ranzor.notion.site/0c0bd4b042de406e96b3e42b0dde3460?pvs=4)

### [📄 발표 보고서 보러가기](https://power-ranzor.notion.site/MVP-d338ce51977c42b7b0daa2340cae2167?pvs=4)

<br>

## 🤝 Project Members

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/7a61f6bf-f7a6-4700-901a-89578bfa352e" width=500px>
</p>

|이름|깃허브|
|---|---|
|서예린|https://github.com/yesrin|
|조우진|https://github.com/VVooJIN3|
|최정은|https://github.com/jungeun5-choi|
|표지수|https://github.com/JisooPyo|

<br>

## Architecture

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/f26aa660-d395-4cd5-b2f2-85ff8ee5e8d6">
</p>

## ERD

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/b17109be-d960-4d6a-8835-309f328f9798" width=800px>
</p>

<br>

## 기술 스택

**Back**

<img src="https://img.shields.io/badge/Java-007396?style=for-the-badge&logo=OpenJDK&logoColor=white"><img src="https://img.shields.io/badge/Spring-6DB33F?style=for-the-badge&logo=spring&logoColor=white"><img src="https://img.shields.io/badge/Spring Boot-6DB33F?style=for-the-badge&logo=springboot&logoColor=white"><img src="https://img.shields.io/badge/Gradle-02303A?style=for-the-badge&logo=gradle&logoColor=white"><img src="https://img.shields.io/badge/MySQL-4479A1?style=for-the-badge&logo=mysql&logoColor=white"><img src="https://img.shields.io/badge/Spring Security-6DB33F?style=for-the-badge&logo=springsecurity&logoColor=white"><img src="https://img.shields.io/badge/Redis-DC382D?style=for-the-badge&logo=redis&logoColor=white">
<br>
<img src="https://img.shields.io/badge/nGrinder-DA742F?style=for-the-badge&logo=&logoColor=white"><img src="https://img.shields.io/badge/GitHub Actions-2088FF?style=for-the-badge&logo=githubactions&logoColor=white"><img src="https://img.shields.io/badge/Amazon AWS-232F3E?style=for-the-badge&logo=amazonaws&logoColor=white"><img src="https://img.shields.io/badge/Amazon S3-569A31?style=for-the-badge&logo=amazons3&logoColor=white"><img src="https://img.shields.io/badge/Amazon EC2-FF9900?style=for-the-badge&logo=amazonec2&logoColor=white"><img src="https://img.shields.io/badge/Amazon CodeDeploy-569A31?style=for-the-badge&logo=&logoColor=white">
<br>
<img src="https://img.shields.io/badge/Amazon RDS-527FFF?style=for-the-badge&logo=amazonrds&logoColor=white"><img src="https://img.shields.io/badge/Amazon CloudWatch-FF4F8B?style=for-the-badge&logo=amazoncloudwatch&logoColor=white"><img src="https://img.shields.io/badge/Amazon ELB-005571?style=for-the-badge&logo=&logoColor=white">
<br>

**Front**

<img src="https://img.shields.io/badge/HTML5-E34F26?style=for-the-badge&logo=html5&logoColor=white"><img src="https://img.shields.io/badge/CSS-1572B6?style=for-the-badge&logo=css3&logoColor=white"><img src="https://img.shields.io/badge/JavaScript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black"><img src="https://img.shields.io/badge/Bootstrap-7952B3?style=for-the-badge&logo=bootstrap&logoColor=black">
<br>

**Tool**

<img src="https://img.shields.io/badge/IntelliJ IDEA-000000?style=for-the-badge&logo=IntelliJ IDEA&logoColor=white"><img src="https://img.shields.io/badge/Github-181717?style=for-the-badge&logo=github&logoColor=white"><img src="https://img.shields.io/badge/git-F05032?style=for-the-badge&logo=git&logoColor=white"><img src="https://img.shields.io/badge/Slack-4A154B?style=for-the-badge&logo=Slack&logoColor=white">
<br>

**Crawling**

<img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white"><img src="https://img.shields.io/badge/Selenium-43B02A?style=for-the-badge&logo=selenium&logoColor=white">
<br>

###### 기술도입배경은 발표보고서에 상세히 기록되어 있습니다.

<br>

## 트러블 슈팅

<details>
<summary>목차</summary>

1. [SQL - 검색 시 사용자가 선택한 조건의 조합에 따른 쿼리 적용 방법 고민](###1.-SQL-:-검색-시-사용자가-선택한-조건의-조합에-따른-쿼리-적용-방법-고민)
2. [동시성 제어 - 한정 상품 동시 주문에 대한 데이터 정확성 확보](###2.-동시성-제어---한정-상품-동시-주문에-대한-데이터-정확성-확보)
3. [멀티스레드 사용으로 CPU 사용률(%) 개선](###3.-멀티스레드-사용으로-CPU-사용률(%)-개선)
4. [다중 서버에서 세션 관리](###4.-다중-서버에서-세션-관리)
5. [AWS 배포 서버 중단 문제](###5.-AWS-배포-서버-중단-문제)

</details>

### 1. SQL : 검색 시 사용자가 선택한 조건의 조합에 따른 쿼리 적용 방법 고민

<br>

> **문제: 여러 조건 중 일부 조건만 선택했을 시 어떻게 처리할 것인가?**

검색 시 **국가, 여행사, 출발 - 도착 날짜, 가격** 조건을 추가 

```
ex) 조건의 조합
조건 1개 : (국가), (여행사), (날짜), (가격) ⇒ **4**
조건 2개 : (국가,여행사), (국가, 날짜), (국가, 가격), (여행사, 날짜), (여행사, 가격), (날짜, 가격) ⇒ **6**
조건 3개 : (국가, 여행사, 날짜), (국가, 여행사, 가격), (국가, 날짜, 가격), (여행사, 날짜, 가격) ⇒ **4**
조건 4개 : (국가, 여행사, 날짜, 가격) ⇒ **1**

**4 + 6 + 4 + 1 = 15**
...

⇒ 다양한 **경우의 수(15가지)**에 각각 해당하는 **조건문**과 **쿼리**를 모두 만들어 사용하는 것은 **매우 비효율적**이다.
```

<br>

> **해결: SQL 쿼리 내에서 아래와 같은 코드 기법 사용**

```sql
SELECT *
  FROM item i
WHERE MATCH(i.name) AGAINST(:search IN BOOLEAN MODE)
    AND (COALESCE(:countries) IS NULL OR country IN (:countries))
    AND (COALESCE(:travelAgencies) IS NULL OR travel_agency_id IN (:travelAgencies))
    AND (:startDate IS NULL OR (DATE(departure_time) = :startDate AND DATE(arrival_time) = :endDate))
    AND (:priceValue IS NULL OR ((:priceAbove = true AND :priceValue <= discount_price) OR (:priceAbove = false AND :priceValue >= discount_price)))
ORDER BY i.id DESC
```

`조건값 IS NULL OR 컬럼 IN(조건값)` 기법 이용

사용자가 조건을 선택하지 않았을 경우 - 프론트엔드로부터 NULL값을 전달 받아 **조건을 TRUE로 만들어** 해당 조건이 실행되지 않음

사용자가 조건을 선택한 경우 - 프론트엔드로부터 조건 값을 전달 받아 **작성한 조건 쿼리를 수행**

**⇒ 하나의 쿼리로 모든 경우의 수를 처리**

<br>

### 2. 동시성 제어 : 한정 상품 동시 주문에 대한 데이터 정확성 확보

<br>

> **문제: 여러 고객이 여행상품을 동시 구매 시, 팔린 아이템 개수 ≠ 구매된 아이템 개수 데이터 불일치 문제 발생**

테스트 조건 : 1,000명이 동시 구매 요청, 수량 : 100개

|남은 Item 수량 체크|구매 개수 체크|
|---|---|
|![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/733238ac-e583-4837-ba3c-6e8e7f48b508)|![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/0b73b4db-54f0-471d-9437-f026cfdbba3d)|
|expected: <0> but was: <6><br>Expected: 0<br>Actual: 6|expected: <100> but was <936><br>Expected: 100<br>Actual: 936|

1000명이 상품 주문을 요청했을 때 아이템 현재 수량과 구매 개수의 예상 값이 다름. ⇒ **데이터 불일치**

> **해결: 비관적 락 사용**

* 데이터 일관성을 보장하는 데 효과적이고 코드가 간결해 관리하기 쉬운 비관적 락 사용
* 테스트 1: `1,000명`이 동시 구매 요청, Item 수량: 100개, Thread: 32 => 통과
![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/2ebe1345-f420-464f-b0ea-f77148295cb4)

* 테스트 2: `5,000명`이 동시 구매 요청, Item 수량: 100개, Thread: 32 => 통과
![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/7c25993b-1fed-4992-be83-ca9cbfdd130e)

**개선 결과 : 동시 주문 요청에 대해 데이터 정확성 확보**

<br>

### 3. 멀티스레드 사용으로 CPU 사용률(%) 개선

<br>



### 4. 다중 서버에서 세션 관리

### 5. AWS 배포 서버 중단 문제


<br>

## 성능 개선



<br>

## 데이터 출처

* [다나와 여행](https://tour.danawa.com/?logger_kw=dnw_gnb_tour)에서 크롤링
* 크롤링 코드 보러가기 -> [Tour-Ranger-Crawling GitHub Repository](https://github.com/Tour-Ranger/Tour-Ranger-Crawling)
