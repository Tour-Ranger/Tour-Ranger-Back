[![develop CI check](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/develop-ci.yml/badge.svg)](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/develop-ci.yml)
[![main-CD](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd.yml/badge.svg)](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd.yml)
[![main-CD-elb](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd-elb.yml/badge.svg)](https://github.com/Tour-Ranger/Tour-Ranger-Back/actions/workflows/main-cd-elb.yml)

# ✈️ Tour-Ranger ✈️

### 🔰 너의 여행을 지켜줄게

프로젝트 기간 : 2023/8/16 ~ 2023/09/18

여행 상품 주문 서비스

1. 대량의 트래픽이 발생할 것으로 예상되는 이벤트 여행 상품(초특가 타임딜) 페이지
2. 대량의 여행 패키지 데이터(천만 건)에서 검색으로 필요한 여행패키지를 빠른 시간 내에 찾을 수 있게 한다.

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/bc807b8a-b684-415a-bc02-caf9a47e6177" height=300px>&nbsp;&nbsp;&nbsp;&nbsp;
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/97c8669b-b5ce-4bd7-af51-4c683a2ffde5" height=300px>
</p>

### [📚 파워레인조 Team Notion 보러가기](https://power-ranzor.notion.site/0c0bd4b042de406e96b3e42b0dde3460?pvs=4)

### [📄 발표 보고서 보러가기](https://power-ranzor.notion.site/MVP-d338ce51977c42b7b0daa2340cae2167?pvs=4)

<br>

## 🤝 Project Members

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/7a61f6bf-f7a6-4700-901a-89578bfa352e" width=500px>
</p>

|이름|깃허브|
|---|---|
|서예린|https://github.com/yesrin|
|조우진|https://github.com/VVooJIN3|
|최정은|https://github.com/jungeun5-choi|
|표지수|https://github.com/JisooPyo|

<br>

## Architecture

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/f26aa660-d395-4cd5-b2f2-85ff8ee5e8d6">
</p>

## ERD

<p align="center">
  <img src="https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/b17109be-d960-4d6a-8835-309f328f9798" width=800px>
</p>

<br>

## 기술 스택

**Back**

<img src="https://img.shields.io/badge/Java-007396?style=for-the-badge&logo=OpenJDK&logoColor=white"><img src="https://img.shields.io/badge/Spring-6DB33F?style=for-the-badge&logo=spring&logoColor=white"><img src="https://img.shields.io/badge/Spring Boot-6DB33F?style=for-the-badge&logo=springboot&logoColor=white"><img src="https://img.shields.io/badge/Gradle-02303A?style=for-the-badge&logo=gradle&logoColor=white"><img src="https://img.shields.io/badge/MySQL-4479A1?style=for-the-badge&logo=mysql&logoColor=white"><img src="https://img.shields.io/badge/Spring Security-6DB33F?style=for-the-badge&logo=springsecurity&logoColor=white"><img src="https://img.shields.io/badge/Redis-DC382D?style=for-the-badge&logo=redis&logoColor=white">
<br>
<img src="https://img.shields.io/badge/nGrinder-DA742F?style=for-the-badge&logo=&logoColor=white"><img src="https://img.shields.io/badge/GitHub Actions-2088FF?style=for-the-badge&logo=githubactions&logoColor=white"><img src="https://img.shields.io/badge/Amazon AWS-232F3E?style=for-the-badge&logo=amazonaws&logoColor=white"><img src="https://img.shields.io/badge/Amazon S3-569A31?style=for-the-badge&logo=amazons3&logoColor=white"><img src="https://img.shields.io/badge/Amazon EC2-FF9900?style=for-the-badge&logo=amazonec2&logoColor=white"><img src="https://img.shields.io/badge/Amazon CodeDeploy-569A31?style=for-the-badge&logo=&logoColor=white">
<br>
<img src="https://img.shields.io/badge/Amazon RDS-527FFF?style=for-the-badge&logo=amazonrds&logoColor=white"><img src="https://img.shields.io/badge/Amazon CloudWatch-FF4F8B?style=for-the-badge&logo=amazoncloudwatch&logoColor=white"><img src="https://img.shields.io/badge/Amazon ELB-005571?style=for-the-badge&logo=&logoColor=white">
<br>

**Front**

<img src="https://img.shields.io/badge/HTML5-E34F26?style=for-the-badge&logo=html5&logoColor=white"><img src="https://img.shields.io/badge/CSS-1572B6?style=for-the-badge&logo=css3&logoColor=white"><img src="https://img.shields.io/badge/JavaScript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black"><img src="https://img.shields.io/badge/Bootstrap-7952B3?style=for-the-badge&logo=bootstrap&logoColor=black">
<br>

**Tool**

<img src="https://img.shields.io/badge/IntelliJ IDEA-000000?style=for-the-badge&logo=IntelliJ IDEA&logoColor=white"><img src="https://img.shields.io/badge/Github-181717?style=for-the-badge&logo=github&logoColor=white"><img src="https://img.shields.io/badge/git-F05032?style=for-the-badge&logo=git&logoColor=white"><img src="https://img.shields.io/badge/Slack-4A154B?style=for-the-badge&logo=Slack&logoColor=white">
<br>

**Crawling**

<img src="https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white"><img src="https://img.shields.io/badge/Selenium-43B02A?style=for-the-badge&logo=selenium&logoColor=white">
<br>

###### 기술도입배경은 발표보고서에 상세히 기록되어 있습니다.

<br>

## 트러블 슈팅

<details>
<summary>1. SQL : 검색 시 사용자가 선택한 조건의 조합에 따른 쿼리 적용 방법 고민</summary>

<br>

> **문제: 여러 조건 중 일부 조건만 선택했을 시 어떻게 처리할 것인가?**

검색 시 **국가, 여행사, 출발 - 도착 날짜, 가격** 조건을 추가 

```
ex) 조건의 조합
조건 1개 : (국가), (여행사), (날짜), (가격) ⇒ 4
조건 2개 : (국가,여행사), (국가, 날짜), (국가, 가격), (여행사, 날짜), (여행사, 가격), (날짜, 가격) ⇒ 6
조건 3개 : (국가, 여행사, 날짜), (국가, 여행사, 가격), (국가, 날짜, 가격), (여행사, 날짜, 가격) ⇒ 4
조건 4개 : (국가, 여행사, 날짜, 가격) ⇒ 1

4 + 6 + 4 + 1 = 15
...
```

⇒ 다양한 **경우의 수(15가지)** 에 각각 해당하는 **조건문**과 **쿼리**를 모두 만들어 사용하는 것은 **매우 비효율적**이다.

<br>

> **해결: SQL 쿼리 내에서 아래와 같은 코드 기법 사용**

```sql
SELECT *
  FROM item i
WHERE MATCH(i.name) AGAINST(:search IN BOOLEAN MODE)
    AND (COALESCE(:countries) IS NULL OR country IN (:countries))
    AND (COALESCE(:travelAgencies) IS NULL OR travel_agency_id IN (:travelAgencies))
    AND (:startDate IS NULL OR (DATE(departure_time) = :startDate AND DATE(arrival_time) = :endDate))
    AND (:priceValue IS NULL OR ((:priceAbove = true AND :priceValue <= discount_price) OR (:priceAbove = false AND :priceValue >= discount_price)))
ORDER BY i.id DESC
```

`조건값 IS NULL OR 컬럼 IN(조건값)` 기법 이용

사용자가 조건을 선택하지 않았을 경우 - 프론트엔드로부터 NULL값을 전달 받아 **조건을 TRUE로 만들어** 해당 조건이 실행되지 않음

사용자가 조건을 선택한 경우 - 프론트엔드로부터 조건 값을 전달 받아 **작성한 조건 쿼리를 수행**

**⇒ 하나의 쿼리로 모든 경우의 수를 처리**

<br>

---

</details>

<details>
  <summary>2. 동시성 제어 : 한정 상품 동시 주문에 대한 데이터 정확성 확보</summary>

<br>

> **문제: 여러 고객이 여행상품을 동시 구매 시, 팔린 아이템 개수 ≠ 구매된 아이템 개수 데이터 불일치 문제 발생**

테스트 조건 : 1,000명이 동시 구매 요청, 수량 : 100개

|남은 Item 수량 체크|구매 개수 체크|
|---|---|
|![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/733238ac-e583-4837-ba3c-6e8e7f48b508)|![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/0b73b4db-54f0-471d-9437-f026cfdbba3d)|
|expected: <0> but was: <6><br>Expected: 0<br>Actual: 6|expected: <100> but was <936><br>Expected: 100<br>Actual: 936|

1000명이 상품 주문을 요청했을 때 아이템 현재 수량과 구매 개수의 예상 값이 다름. ⇒ **데이터 불일치**

> **해결: 비관적 락 사용**

* 데이터 일관성을 보장하는 데 효과적이고 코드가 간결해 관리하기 쉬운 비관적 락 사용
* 테스트 1: `1,000명`이 동시 구매 요청, Item 수량: 100개, Thread: 32 => 통과
![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/2ebe1345-f420-464f-b0ea-f77148295cb4)

* 테스트 2: `5,000명`이 동시 구매 요청, Item 수량: 100개, Thread: 32 => 통과
![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/7c25993b-1fed-4992-be83-ca9cbfdd130e)

**개선 결과: 동시 주문 요청에 대해 데이터 정확성 확보**
  
</details>

<details>
<summary>3. 멀티스레드 사용으로 CPU 사용률(%) 개선</summary>

<br>

> **문제: 부하테스트를 진행하는 중이었음에도 CPU 사용률이 저조했다.**

![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/c3ed3f4b-8268-4e53-b2ad-b92b5e411f3f)

**비관적 락**을 사용하면 대기 시간이 길어진다. 그럼에도 테스트에서는 예상수치보다 한참 낮은 두 자릿 수의 TPS를 달성하였다.

원인을 찾기 위해 CloudWatch를 통한 모니터링을 진행하였고, 우선 (부하테스트로 인해서) CPU가 과열된 것은 아닌지부터 모니터링 해보았다. 하지만 CPU 사용률은 전혀 높지 않았고, 오히려 부하테스트를 진행하지 않을 때와 사용률이 거의 유사했다.

![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/878cc246-b461-4aba-a446-a2752f04bc72)

CloudWatch를 통해 CPU 사용률을 모니터링한 화면이다. VUser를 1000만큼 설정하여 테스트하였음에도 **약 11.7%** 라는 저조한 사용률을 보이고 있다.

관점을 바꿔서 **스프링 애플리케이션이** **CPU를 제대로 사용하지 못하고 있다고 판단**하게 되었고, 이 부분에서 개선이 필요하다고 생각했다.

> **해결: 멀티스레드 사용 설정 및 멀티스레드 운용을 위한 EC2 인스턴스 스케일 업**

1. 필요한 서비스에 멀티스레드 사용 설정 `@Async`

```java
@Async("taskExecutor")
public void purchaseItem(Long itemId, PurchaseRequestDto requestDto) {
		/* 상품 구매 로직 */
}
```

2. 멀티스레드 운용을 위한 EC2 인스턴스 스케일 업
  a. 기존에 사용하던 인스턴스 타입인 **t2.medium**은, 2 vCPU로, CPU 코어가 2개 밖에 없었다.
     CPU 코어 수가 적어서 멀티스레드를 사용하더라도 큰 효과가 없을 것이라 판단했고, CPU 코어가 4개이면서 가장 저렴한 **t3a.xlarge**를 선택하였다.
  b. 코어 : 스레드 = 1:1 비율로 맞추어, **기본 스레드는 4만큼** 설정해주었다.
        
```java
@Configuration
public class AsyncConfig {
    @Bean(name = "taskExecutor")
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        **executor.setCorePoolSize(4); // 기본 스레드 수**
        /* ... 그 외 설정 ... */
        return executor;
    }
}
```
        
3. 결과
    
![image](https://github.com/Tour-Ranger/Tour-Ranger-Back/assets/130378232/2c569805-a969-4e1c-8d62-bed2a2b84872)

멀티스레드 사용 전에 진행했던 테스트와 동일한 설정 (테스트 시간 제외*)으로 부하테스트를 실행하였다.
    
이번에는 **약 31.8%** 로, 이전보다 높은 사용률을 보였다.
    
오히려 EC2 인스턴스를 스케일 업을 통해 처리성능이 더 좋아졌음에도, 스케일 업 전보다 더 높은 CPU 사용률을 보이고 있다.
    
###### 테스트 시간이 부족하여 기존 30분 → 15분으로 단축하여 테스트를 진행했습니다.

</details>


<details>
<summary>4. 다중 서버에서 세션 관리</summary>

<br>

> **문제:**

> **해결:**
  
</details>


<details>
<summary>5. AWS 배포 서버 중단 문제</summary>

<br>

> **문제:**

> **해결:**

<br>
  
</details>

<br>

## 성능 개선



<br>

## 데이터 출처

* [다나와 여행](https://tour.danawa.com/?logger_kw=dnw_gnb_tour)에서 크롤링
* 크롤링 코드 보러가기 -> [Tour-Ranger-Crawling GitHub Repository](https://github.com/Tour-Ranger/Tour-Ranger-Crawling)
